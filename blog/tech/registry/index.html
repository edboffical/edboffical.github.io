<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>ä¸€æ¬¡ lua è™šæ‹Ÿæœºå †æ ˆæº¢å‡ºæ’æŸ¥ - callous' blog</title><meta name=keywords content="tech"><meta name=description content="èµ·å›  è¿™ä¸€æ¬¡çš„é—®é¢˜å‡ºç°åœ¨æˆ‘å¼€å‘çš„å®‰å…¨ç³»ç»Ÿçš„ agent ä¸­ï¼Œåœ¨æ­£å¼å‘å¸ƒä¹‹å‰ï¼Œæµ‹è¯•åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œè¿˜ç®—å¹¸è¿ğŸ˜… åœ¨å†…ç½‘æµ‹è¯•ç¯å¢ƒä¸­ï¼Œagent ä¸€ç›´éƒ½æ²¡å‡ºç°é—®é¢˜ï¼Œç›´åˆ°è¿è¡Œäº”å…­å¤©åï¼Œçªç„¶å‘ç° lua è™šæ‹Ÿæœºå´©æºƒäº†&mldr;
æ—¥å¿—åˆ†æ {&#34;level&#34;:&#34;error&#34;,&#34;ts&#34;:&#34;2021-05-31 19:50:27.023&#34;,&#34;caller&#34;:&#34;workers/luaworker.go:132&#34;,&#34;msg&#34;:&#34;call run func failed&#34;,&#34;error&#34;:&#34;/data/dep/agent/lua/utils.lua:38: registry overflow\nstack traceback:\n\t[G]: in function 'gsub'\n\t/data/dep/agent/lua/utils.lua:38: in function 'split'\n\tlua/port.lua:42: in function 'inspect'\n\tlua/port.lua:21: in main chunk\n\t[G]: ?&#34;,&#34;lua&#34;:&#34;port.lua&#34;} {&#34;level&#34;:&#34;error&#34;,&#34;ts&#34;:&#34;2021-05-31 19:51:27.104&#34;,&#34;caller&#34;:&#34;workers/luaworker.go:132&#34;,&#34;msg&#34;:&#34;call run func failed&#34;,&#34;error&#34;:&#34;/data/dep/agent/lua/utils.lua:38: registry overflow\nstack traceback:\n\t[G]: in function 'gsub'\n\t/data/dep/agent/lua/utils.lua:38: in function 'split'\n\tlua/port.lua:42: in function 'inspect'\n\tlua/port.lua:21: in main chunk\n\t[G]: ?&#34;,&#34;lua&#34;:&#34;port.lua&#34;} {&#34;level&#34;:&#34;error&#34;,&#34;ts&#34;:&#34;2021-05-31 19:53:27.296&#34;,&#34;caller&#34;:&#34;workers/luaworker.go:132&#34;,&#34;msg&#34;:&#34;call run func failed&#34;,&#34;error&#34;:&#34;/data/dep/agent/lua/utils.lua:38: registry overflow\nstack traceback:\n\t[G]: in function 'gsub'\n\t/data/dep/agent/lua/utils.lua:38: in function 'split'\n\tlua/port.lua:42: in function 'inspect'\n\tlua/port.lua:21: in main chunk\n\t[G]: ?"><meta name=author content="callous"><link rel=canonical href=https://callous.cn/blog/tech/registry/><link href=https://callous.cn/assets/css/stylesheet.min.595f5ecef354f9eb94e43d831cd360dcf8b7727542e731c55a7875c9e94a9577.css integrity="sha256-WV9ezvNU+euU5D2DHNNg3Pi3cnVC5zHFWnh1yelKlXc=" rel="preload stylesheet" as=style><link rel=manifest href=https://callous.cn/site.webmanifest><link rel=icon href=https://callous.cn/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://callous.cn/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://callous.cn/favicon-32x32.png><link rel=apple-touch-icon href=https://callous.cn/apple-touch-icon.png><link rel=mask-icon href=https://callous.cn/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.78.1"><meta property="og:title" content="ä¸€æ¬¡ lua è™šæ‹Ÿæœºå †æ ˆæº¢å‡ºæ’æŸ¥"><meta property="og:description" content="èµ·å›  è¿™ä¸€æ¬¡çš„é—®é¢˜å‡ºç°åœ¨æˆ‘å¼€å‘çš„å®‰å…¨ç³»ç»Ÿçš„ agent ä¸­ï¼Œåœ¨æ­£å¼å‘å¸ƒä¹‹å‰ï¼Œæµ‹è¯•åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œè¿˜ç®—å¹¸è¿ğŸ˜… åœ¨å†…ç½‘æµ‹è¯•ç¯å¢ƒä¸­ï¼Œagent ä¸€ç›´éƒ½æ²¡å‡ºç°é—®é¢˜ï¼Œç›´åˆ°è¿è¡Œäº”å…­å¤©åï¼Œçªç„¶å‘ç° lua è™šæ‹Ÿæœºå´©æºƒäº†&mldr;
æ—¥å¿—åˆ†æ {&#34;level&#34;:&#34;error&#34;,&#34;ts&#34;:&#34;2021-05-31 19:50:27.023&#34;,&#34;caller&#34;:&#34;workers/luaworker.go:132&#34;,&#34;msg&#34;:&#34;call run func failed&#34;,&#34;error&#34;:&#34;/data/dep/agent/lua/utils.lua:38: registry overflow\nstack traceback:\n\t[G]: in function 'gsub'\n\t/data/dep/agent/lua/utils.lua:38: in function 'split'\n\tlua/port.lua:42: in function 'inspect'\n\tlua/port.lua:21: in main chunk\n\t[G]: ?&#34;,&#34;lua&#34;:&#34;port.lua&#34;} {&#34;level&#34;:&#34;error&#34;,&#34;ts&#34;:&#34;2021-05-31 19:51:27.104&#34;,&#34;caller&#34;:&#34;workers/luaworker.go:132&#34;,&#34;msg&#34;:&#34;call run func failed&#34;,&#34;error&#34;:&#34;/data/dep/agent/lua/utils.lua:38: registry overflow\nstack traceback:\n\t[G]: in function 'gsub'\n\t/data/dep/agent/lua/utils.lua:38: in function 'split'\n\tlua/port.lua:42: in function 'inspect'\n\tlua/port.lua:21: in main chunk\n\t[G]: ?&#34;,&#34;lua&#34;:&#34;port.lua&#34;} {&#34;level&#34;:&#34;error&#34;,&#34;ts&#34;:&#34;2021-05-31 19:53:27.296&#34;,&#34;caller&#34;:&#34;workers/luaworker.go:132&#34;,&#34;msg&#34;:&#34;call run func failed&#34;,&#34;error&#34;:&#34;/data/dep/agent/lua/utils.lua:38: registry overflow\nstack traceback:\n\t[G]: in function 'gsub'\n\t/data/dep/agent/lua/utils.lua:38: in function 'split'\n\tlua/port.lua:42: in function 'inspect'\n\tlua/port.lua:21: in main chunk\n\t[G]: ?"><meta property="og:type" content="article"><meta property="og:url" content="https://callous.cn/blog/tech/registry/"><meta property="article:published_time" content="2021-06-03T17:00:00+08:00"><meta property="article:modified_time" content="2021-06-03T17:00:00+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="ä¸€æ¬¡ lua è™šæ‹Ÿæœºå †æ ˆæº¢å‡ºæ’æŸ¥"><meta name=twitter:description content="èµ·å›  è¿™ä¸€æ¬¡çš„é—®é¢˜å‡ºç°åœ¨æˆ‘å¼€å‘çš„å®‰å…¨ç³»ç»Ÿçš„ agent ä¸­ï¼Œåœ¨æ­£å¼å‘å¸ƒä¹‹å‰ï¼Œæµ‹è¯•åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œè¿˜ç®—å¹¸è¿ğŸ˜… åœ¨å†…ç½‘æµ‹è¯•ç¯å¢ƒä¸­ï¼Œagent ä¸€ç›´éƒ½æ²¡å‡ºç°é—®é¢˜ï¼Œç›´åˆ°è¿è¡Œäº”å…­å¤©åï¼Œçªç„¶å‘ç° lua è™šæ‹Ÿæœºå´©æºƒäº†&mldr;
æ—¥å¿—åˆ†æ {&#34;level&#34;:&#34;error&#34;,&#34;ts&#34;:&#34;2021-05-31 19:50:27.023&#34;,&#34;caller&#34;:&#34;workers/luaworker.go:132&#34;,&#34;msg&#34;:&#34;call run func failed&#34;,&#34;error&#34;:&#34;/data/dep/agent/lua/utils.lua:38: registry overflow\nstack traceback:\n\t[G]: in function 'gsub'\n\t/data/dep/agent/lua/utils.lua:38: in function 'split'\n\tlua/port.lua:42: in function 'inspect'\n\tlua/port.lua:21: in main chunk\n\t[G]: ?&#34;,&#34;lua&#34;:&#34;port.lua&#34;} {&#34;level&#34;:&#34;error&#34;,&#34;ts&#34;:&#34;2021-05-31 19:51:27.104&#34;,&#34;caller&#34;:&#34;workers/luaworker.go:132&#34;,&#34;msg&#34;:&#34;call run func failed&#34;,&#34;error&#34;:&#34;/data/dep/agent/lua/utils.lua:38: registry overflow\nstack traceback:\n\t[G]: in function 'gsub'\n\t/data/dep/agent/lua/utils.lua:38: in function 'split'\n\tlua/port.lua:42: in function 'inspect'\n\tlua/port.lua:21: in main chunk\n\t[G]: ?&#34;,&#34;lua&#34;:&#34;port.lua&#34;} {&#34;level&#34;:&#34;error&#34;,&#34;ts&#34;:&#34;2021-05-31 19:53:27.296&#34;,&#34;caller&#34;:&#34;workers/luaworker.go:132&#34;,&#34;msg&#34;:&#34;call run func failed&#34;,&#34;error&#34;:&#34;/data/dep/agent/lua/utils.lua:38: registry overflow\nstack traceback:\n\t[G]: in function 'gsub'\n\t/data/dep/agent/lua/utils.lua:38: in function 'split'\n\tlua/port.lua:42: in function 'inspect'\n\tlua/port.lua:21: in main chunk\n\t[G]: ?"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"ä¸€æ¬¡ lua è™šæ‹Ÿæœºå †æ ˆæº¢å‡ºæ’æŸ¥","name":"ä¸€æ¬¡ lua è™šæ‹Ÿæœºå †æ ˆæº¢å‡ºæ’æŸ¥","description":"èµ·å›  è¿™ä¸€æ¬¡çš„é—®é¢˜å‡ºç°åœ¨æˆ‘å¼€å‘çš„å®‰å…¨ç³»ç»Ÿçš„ agent ä¸­ï¼Œåœ¨æ­£å¼å‘å¸ƒä¹‹å‰ï¼Œæµ‹è¯•åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œè¿˜ç®—å¹¸è¿ğŸ˜… åœ¨å†…ç½‘æµ‹è¯•ç¯å¢ƒä¸­ï¼Œagent ä¸€ç›´éƒ½æ²¡å‡ºç°é—®é¢˜ï¼Œç›´åˆ°è¿è¡Œäº”å…­å¤©åï¼Œçªç„¶å‘ç° lua è™šæ‹Ÿæœºå´©æºƒäº†\u0026amp;hellip; â€¦","keywords":["tech"],"articleBody":"èµ·å›  è¿™ä¸€æ¬¡çš„é—®é¢˜å‡ºç°åœ¨æˆ‘å¼€å‘çš„å®‰å…¨ç³»ç»Ÿçš„ agent ä¸­ï¼Œåœ¨æ­£å¼å‘å¸ƒä¹‹å‰ï¼Œæµ‹è¯•åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œè¿˜ç®—å¹¸è¿ğŸ˜… åœ¨å†…ç½‘æµ‹è¯•ç¯å¢ƒä¸­ï¼Œagent ä¸€ç›´éƒ½æ²¡å‡ºç°é—®é¢˜ï¼Œç›´åˆ°è¿è¡Œäº”å…­å¤©åï¼Œçªç„¶å‘ç° lua è™šæ‹Ÿæœºå´©æºƒäº†â€¦\næ—¥å¿—åˆ†æ {\"level\":\"error\",\"ts\":\"2021-05-31 19:50:27.023\",\"caller\":\"workers/luaworker.go:132\",\"msg\":\"call run func failed\",\"error\":\"/data/dep/agent/lua/utils.lua:38: registry overflow\\nstack traceback:\\n\\t[G]: in function 'gsub'\\n\\t/data/dep/agent/lua/utils.lua:38: in function 'split'\\n\\tlua/port.lua:42: in function 'inspect'\\n\\tlua/port.lua:21: in main chunk\\n\\t[G]: ?\",\"lua\":\"port.lua\"} {\"level\":\"error\",\"ts\":\"2021-05-31 19:51:27.104\",\"caller\":\"workers/luaworker.go:132\",\"msg\":\"call run func failed\",\"error\":\"/data/dep/agent/lua/utils.lua:38: registry overflow\\nstack traceback:\\n\\t[G]: in function 'gsub'\\n\\t/data/dep/agent/lua/utils.lua:38: in function 'split'\\n\\tlua/port.lua:42: in function 'inspect'\\n\\tlua/port.lua:21: in main chunk\\n\\t[G]: ?\",\"lua\":\"port.lua\"} {\"level\":\"error\",\"ts\":\"2021-05-31 19:53:27.296\",\"caller\":\"workers/luaworker.go:132\",\"msg\":\"call run func failed\",\"error\":\"/data/dep/agent/lua/utils.lua:38: registry overflow\\nstack traceback:\\n\\t[G]: in function 'gsub'\\n\\t/data/dep/agent/lua/utils.lua:38: in function 'split'\\n\\tlua/port.lua:42: in function 'inspect'\\n\\tlua/port.lua:21: in main chunk\\n\\t[G]: ?\",\"lua\":\"port.lua\"} è¿™é‡Œåªæˆªå–äº†å‡ æ¡ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå…³é”®ä¿¡æ¯å°±æ˜¯ registry overflow ã€‚\næ•…éšœå®šä½ é¡¹ç›®ä¸­çš„ Lua è™šæ‹Ÿæœºæ˜¯ GopherLua æ˜¯ç”¨ Go è¯­è¨€ç¼–å†™çš„ Lua 5.1 çš„è™šæ‹Ÿæœºå’Œç¼–è¯‘å™¨ã€‚è½»é‡åŒ–ã€æ€§èƒ½é«˜ã€‚\nå…ˆçœ‹ä¸€ä¸‹è¿™ä¸ª registry æ˜¯ä»€ä¹ˆï¼Œåœ¨é¡¹ç›®ä¸­çš„è§£é‡Šï¼š\n  The registry of an LState implements stack storage for calling functions (both Lua and Go functions) and also for temporary variables in expressions. Its storage requirements will increase with callstack usage and also with code complexity.\n  å°±æ˜¯è°ƒç”¨å‡½æ•°ï¼ˆåŒ…æ‹¬ lua å’Œ goï¼‰å’Œä¸´æ—¶å˜é‡çš„å †æ ˆã€‚\nåº•å±‚æºç é˜…è¯» æ¥çœ‹ä¸‹ registry çš„åº•å±‚ç»“æ„\ntype registry struct { array []LValue top int growBy int maxSize int alloc *allocator handler registryHandler } ä¸»è¦çœ‹ array å’Œ topï¼Œå…¶ä¸­ array ç”¨æ¥ä¿å­˜æ ˆå€¼ï¼Œtop æ˜¯ç”¨æ¥è®°å½•æ ˆé¡¶æŒ‡é’ˆã€‚\nç„¶åï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ä»€ä¹ˆæƒ…å†µä¸‹ä¼šè§¦å‘å †æ ˆæº¢å‡ºã€‚\nfunc (rg *registry) Push(v LValue) { newSize := rg.top + 1 // this section is inlined by go-inline \t// source function is 'func (rg *registry) checkSize(requiredSize int) ' in '_state.go' \t{ requiredSize := newSize if requiredSize  cap(rg.array) { rg.resize(requiredSize) } } rg.array[rg.top] = v rg.top++ } ä» Push æ“ä½œä¸­å¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸€æ¬¡ Push éƒ½ä¼šæ£€æŸ¥æ ˆå®¹é‡æ˜¯å¦è¶³å¤Ÿï¼Œå¦‚æœä¸å¤Ÿå°±ä¼šè§¦å‘ resizeã€‚\nfunc (rg *registry) resize(requiredSize int) { // +inline-start \tnewSize := requiredSize + rg.growBy // give some padding \tif newSize  rg.maxSize { newSize = rg.maxSize } if newSize requiredSize { rg.handler.registryOverflow() return } rg.forceResize(newSize) } // +inline-end è€Œåœ¨ resize å‡½æ•°ä¸­ï¼Œå¯ä»¥æ¸…æ¥šçš„çœ‹åˆ°ï¼Œå½“æ ˆå®¹é‡è¶…è¿‡ maxSize ï¼ˆé»˜è®¤ä¸º 5120ï¼‰çš„æ—¶å€™å°±ä¼šè§¦å‘ registryOverflow å³å †æ ˆæº¢å‡ºã€‚\nè‡³æ­¤ï¼Œé—®é¢˜å…¶å®å·²ç»ååˆ†æ˜ç¡®äº†ã€‚åº”è¯¥æ˜¯æŸäº›æ“ä½œå‹æ ˆä¹‹åæ²¡æœ‰å–å‡ºï¼Œå¯¼è‡´å †æ ˆä¸€ç›´å †ç§¯ï¼Œæœ€åå¯¼è‡´æº¢å‡ºã€‚\nDebug åœ¨è¿›è¡Œ Debug çš„æ—¶å€™å‘ç°ï¼Œåœ¨æ¯ä¸€æ¬¡è™šæ‹Ÿæœºå›æ”¶çš„æ—¶å€™ï¼Œæ ˆé¡¶æŒ‡é’ˆä¸€ç›´åœ¨é€’å¢ï¼š\nå‰ä¸€æ¬¡å›æ”¶ï¼š åä¸€æ¬¡å›æ”¶ï¼š æ ˆå€¼éƒ½æ˜¯ LNilï¼š æŒ‰ç…§æ—¶é—´æ¨ç®—ï¼Œagent çš„è„šæœ¬ä¸€åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼Œé‚£ä¹ˆå †æ»¡ä¸€ä¸ªå®¹é‡ 5120 çš„è™šæ‹Ÿæœºå †æ ˆï¼Œéœ€è¦ 1 å¤©å¤šï¼Œ4 ä¸ªè™šæ‹Ÿæœºå®ä¾‹æ­£å¥½å°±æ˜¯ 5 å¤©å·¦å³ï¼Œå®Œå…¨ç¬¦åˆæ•…éšœç°è±¡ã€‚\næ’æŸ¥é—®é¢˜ æ¥ä¸‹æ¥ï¼Œæœ€ä¸»è¦å°±æ˜¯æ‰¾åˆ°é—®é¢˜çš„åŸå› ï¼Œé¦–å…ˆéœ€è¦æ˜ç¡®åˆ°åº•æ˜¯ go å¯¼è‡´äº†å †æ ˆå †ç§¯è¿˜æ˜¯è°ƒç”¨ lua è„šæœ¬çš„æ—¶å€™å¯¼è‡´çš„ã€‚\näºæ˜¯ï¼Œæˆ‘å°±å†™äº†ä¸€ä¸ªååˆ†ç®€å•çš„æµ‹è¯• lua è„šæœ¬ï¼Œåª print ä¸€æ¡ä¿¡æ¯ã€‚\nç„¶åï¼Œæˆ‘å‘ç°è™šæ‹Ÿæœºå›æ”¶çš„æ—¶å€™å †æ ˆä¾æ—§åœ¨å †ç§¯ã€‚è¯´æ˜é—®é¢˜å¤§æ¦‚ç‡å‡ºåœ¨ go é‡Œã€‚\næ‰€ä»¥æˆ‘åˆä»”ç»†å›é¡¾äº† agent é‡Œè™šæ‹Ÿæœºçš„æ‰§è¡Œæµç¨‹ï¼Œå‘ç°è¿™å¤„ä»£ç ï¼š\n// è°ƒç”¨ run å‡½æ•° if err := vm.CallByParam(lua.P{ Fn: rfn, NRet: 1, Protect: true, }, nil); err != nil { log.Logger.Error(\"call run func failed\", zap.Error(err), zap.Any(\"lua\", lname)) } // å½’è¿˜è™šæ‹Ÿæœº luavm.Put(vm) é—®é¢˜è²Œä¼¼å°±åœ¨è¿™é‡Œï¼Œæ˜¯ä¸æ˜¯è°ƒç”¨ lua è„šæœ¬ä¸­çš„ run å‡½æ•°åå°†ç»“æœå‹æ ˆäº†ï¼Œç„¶åæ²¡æœ‰è¿›è¡Œ POP ï¼Ÿ\nagent ä¸­è°ƒç”¨çš„ lua è„šæœ¬æ˜¯ä¸è¿”å›å€¼çš„ï¼Œè¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆæ ˆå€¼éƒ½æ˜¯ LNilã€‚\nä¸ºäº†éªŒè¯è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘å°†æµ‹è¯•è„šæœ¬ä¸­çš„ run æ–¹æ³•æ”¹æˆäº†å¦‚ä¸‹ï¼š\nfunction run() inspect() return 123 end ç„¶åï¼Œæˆ‘ä»¬å†æ¥ Debug çœ‹ä¸‹å †æ ˆé‡Œçš„æƒ…å†µ\næœç„¶ï¼Œç±»å‹ä» LNil å˜æˆäº† LNumberï¼Œé—®é¢˜æœç„¶åœ¨è¿™é‡Œï¼\nä¿®å¤ // è°ƒç”¨ run å‡½æ•° if err := vm.CallByParam(lua.P{ Fn: rfn, NRet: 1, Protect: true, }, nil); err != nil { log.Logger.Error(\"call run func failed\", zap.Error(err), zap.Any(\"lua\", lname)) } // ç›¸ä¿¡æˆ‘ï¼Œè°ƒç”¨ call åä¸€å®šè¦ pop ï¼ï¼ä¸ç„¶ä¸€å®šä¸ä¼šè®©ä½ å¤±æœ› vm.Pop(1) // å½’è¿˜è™šæ‹Ÿæœº luavm.Put(vm) ä¿®å¤è¿™ä¸ªé—®é¢˜å¾ˆç®€å•ï¼Œåªéœ€åœ¨å½’è¿˜è™šæ‹Ÿæœºå‰ï¼Œæ‰§è¡Œä¸€æ¬¡ POPã€‚éšåå‘ç°æ¯æ¬¡å›æ”¶è™šæ‹Ÿæœºçš„æ—¶å€™ï¼Œå°±æ²¡æœ‰æ ˆå †ç§¯çš„æƒ…å†µäº†ã€‚\nå¦å¤–ï¼Œä¹Ÿå¯ä»¥åœ¨è™šæ‹Ÿæœºå›æ”¶çš„æ—¶å€™åšä¸€äº›èµ„æºæ¸…ç†ã€‚\næ€»ç»“ å¤šé˜…è¯»åº•å±‚å®ç°ï¼Œå¤šå»æªæªé—®é¢˜çš„æœ¬è´¨ï¼Œä¸€èˆ¬æ²¡æœ‰ä»€ä¹ˆè§£å†³ä¸äº†çš„é—®é¢˜ğŸ˜\n","wordCount":"396","inLanguage":"en","datePublished":"2021-06-03T17:00:00+08:00","dateModified":"2021-06-03T17:00:00+08:00","author":{"@type":"Person","name":"callous"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://callous.cn/blog/tech/registry/"},"publisher":{"@type":"Organization","name":"callous' blog","logo":{"@type":"ImageObject","url":"https://callous.cn/favicon.ico"}}}</script></head><body class=single id=top><script>if(localStorage.getItem("pref-theme")==="dark"){document.body.classList.add('dark');}else if(localStorage.getItem("pref-theme")==="light"){document.body.classList.remove('dark')}else if(window.matchMedia('(prefers-color-scheme: dark)').matches){document.body.classList.add('dark');}</script><noscript><style type=text/css>.theme-toggle,.top-link{display:none}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://callous.cn accesskey=h>callous' blog</a>
<span class=logo-switches><span class=theme-toggle><a id=theme-toggle accesskey=t><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></a></span></span></div><ul class=menu id=menu onscroll=menu_on_scroll()><li><a href=https://callous.cn/archives/><span>Archives</span></a></li><li><a href=https://callous.cn/tags/><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>ä¸€æ¬¡ lua è™šæ‹Ÿæœºå †æ ˆæº¢å‡ºæ’æŸ¥<div class=entry-isdraft><sup>&nbsp;&nbsp;[draft]</sup></div></h1><div class=post-meta>June 3, 2021&nbsp;Â·&nbsp;2 min&nbsp;Â·&nbsp;callous</div></header><div class=post-content><h2 id=èµ·å› >èµ·å› </h2><p>è¿™ä¸€æ¬¡çš„é—®é¢˜å‡ºç°åœ¨æˆ‘å¼€å‘çš„å®‰å…¨ç³»ç»Ÿçš„ <strong>agent</strong> ä¸­ï¼Œåœ¨æ­£å¼å‘å¸ƒä¹‹å‰ï¼Œæµ‹è¯•åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œè¿˜ç®—å¹¸è¿ğŸ˜…
åœ¨å†…ç½‘æµ‹è¯•ç¯å¢ƒä¸­ï¼Œ<strong>agent</strong> ä¸€ç›´éƒ½æ²¡å‡ºç°é—®é¢˜ï¼Œç›´åˆ°è¿è¡Œäº”å…­å¤©åï¼Œçªç„¶å‘ç° lua è™šæ‹Ÿæœºå´©æºƒäº†&mldr;</p><h2 id=æ—¥å¿—åˆ†æ>æ—¥å¿—åˆ†æ</h2><pre><code>{&quot;level&quot;:&quot;error&quot;,&quot;ts&quot;:&quot;2021-05-31 19:50:27.023&quot;,&quot;caller&quot;:&quot;workers/luaworker.go:132&quot;,&quot;msg&quot;:&quot;call run func failed&quot;,&quot;error&quot;:&quot;/data/dep/agent/lua/utils.lua:38: registry overflow\nstack traceback:\n\t[G]: in function 'gsub'\n\t/data/dep/agent/lua/utils.lua:38: in function 'split'\n\tlua/port.lua:42: in function 'inspect'\n\tlua/port.lua:21: in main chunk\n\t[G]: ?&quot;,&quot;lua&quot;:&quot;port.lua&quot;}
{&quot;level&quot;:&quot;error&quot;,&quot;ts&quot;:&quot;2021-05-31 19:51:27.104&quot;,&quot;caller&quot;:&quot;workers/luaworker.go:132&quot;,&quot;msg&quot;:&quot;call run func failed&quot;,&quot;error&quot;:&quot;/data/dep/agent/lua/utils.lua:38: registry overflow\nstack traceback:\n\t[G]: in function 'gsub'\n\t/data/dep/agent/lua/utils.lua:38: in function 'split'\n\tlua/port.lua:42: in function 'inspect'\n\tlua/port.lua:21: in main chunk\n\t[G]: ?&quot;,&quot;lua&quot;:&quot;port.lua&quot;}
{&quot;level&quot;:&quot;error&quot;,&quot;ts&quot;:&quot;2021-05-31 19:53:27.296&quot;,&quot;caller&quot;:&quot;workers/luaworker.go:132&quot;,&quot;msg&quot;:&quot;call run func failed&quot;,&quot;error&quot;:&quot;/data/dep/agent/lua/utils.lua:38: registry overflow\nstack traceback:\n\t[G]: in function 'gsub'\n\t/data/dep/agent/lua/utils.lua:38: in function 'split'\n\tlua/port.lua:42: in function 'inspect'\n\tlua/port.lua:21: in main chunk\n\t[G]: ?&quot;,&quot;lua&quot;:&quot;port.lua&quot;}
</code></pre><p>è¿™é‡Œåªæˆªå–äº†å‡ æ¡ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå…³é”®ä¿¡æ¯å°±æ˜¯ <strong>registry overflow</strong> ã€‚</p><h2 id=æ•…éšœå®šä½>æ•…éšœå®šä½</h2><p>é¡¹ç›®ä¸­çš„ <code>Lua</code> è™šæ‹Ÿæœºæ˜¯ <a href=https://github.com/yuin/gopher-lua>GopherLua</a> æ˜¯ç”¨ Go è¯­è¨€ç¼–å†™çš„ Lua 5.1 çš„è™šæ‹Ÿæœºå’Œç¼–è¯‘å™¨ã€‚è½»é‡åŒ–ã€æ€§èƒ½é«˜ã€‚</p><p>å…ˆçœ‹ä¸€ä¸‹è¿™ä¸ª <code>registry</code> æ˜¯ä»€ä¹ˆï¼Œåœ¨é¡¹ç›®ä¸­çš„è§£é‡Šï¼š</p><blockquote><blockquote><p>The registry of an LState implements stack storage for calling functions (both Lua and Go functions) and also for temporary variables in expressions. Its storage requirements will increase with callstack usage and also with code complexity.</p></blockquote></blockquote><p>å°±æ˜¯è°ƒç”¨å‡½æ•°ï¼ˆåŒ…æ‹¬ lua å’Œ goï¼‰å’Œä¸´æ—¶å˜é‡çš„å †æ ˆã€‚</p><h3 id=åº•å±‚æºç é˜…è¯»>åº•å±‚æºç é˜…è¯»</h3><p>æ¥çœ‹ä¸‹ <a href=https://github.com/yuin/gopher-lua/blob/f4c35e4016d9d8580b007ebaeb68ecd8e0b09f1c/state.go#L369><code>registry</code></a> çš„åº•å±‚ç»“æ„</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>registry</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>array</span>   []<span style=color:#a6e22e>LValue</span>
	<span style=color:#a6e22e>top</span>     <span style=color:#66d9ef>int</span>
	<span style=color:#a6e22e>growBy</span>  <span style=color:#66d9ef>int</span>
	<span style=color:#a6e22e>maxSize</span> <span style=color:#66d9ef>int</span>
	<span style=color:#a6e22e>alloc</span>   <span style=color:#f92672>*</span><span style=color:#a6e22e>allocator</span>
	<span style=color:#a6e22e>handler</span> <span style=color:#a6e22e>registryHandler</span>
}
</code></pre></div><p>ä¸»è¦çœ‹ <code>array</code> å’Œ <code>top</code>ï¼Œå…¶ä¸­ <code>array</code> ç”¨æ¥ä¿å­˜æ ˆå€¼ï¼Œ<code>top</code> æ˜¯ç”¨æ¥è®°å½•æ ˆé¡¶æŒ‡é’ˆã€‚</p><p>ç„¶åï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ä»€ä¹ˆæƒ…å†µä¸‹ä¼šè§¦å‘å †æ ˆæº¢å‡ºã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rg</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>) <span style=color:#a6e22e>Push</span>(<span style=color:#a6e22e>v</span> <span style=color:#a6e22e>LValue</span>) {
	<span style=color:#a6e22e>newSize</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rg</span>.<span style=color:#a6e22e>top</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
	<span style=color:#75715e>// this section is inlined by go-inline
</span><span style=color:#75715e></span>	<span style=color:#75715e>// source function is &#39;func (rg *registry) checkSize(requiredSize int) &#39; in &#39;_state.go&#39;
</span><span style=color:#75715e></span>	{
		<span style=color:#a6e22e>requiredSize</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>newSize</span>
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>requiredSize</span> &gt; cap(<span style=color:#a6e22e>rg</span>.<span style=color:#a6e22e>array</span>) {
			<span style=color:#a6e22e>rg</span>.<span style=color:#a6e22e>resize</span>(<span style=color:#a6e22e>requiredSize</span>)
		}
	}
	<span style=color:#a6e22e>rg</span>.<span style=color:#a6e22e>array</span>[<span style=color:#a6e22e>rg</span>.<span style=color:#a6e22e>top</span>] = <span style=color:#a6e22e>v</span>
	<span style=color:#a6e22e>rg</span>.<span style=color:#a6e22e>top</span><span style=color:#f92672>++</span>
}
</code></pre></div><p>ä» <a href=https://github.com/yuin/gopher-lua/blob/f4c35e4016d9d8580b007ebaeb68ecd8e0b09f1c/state.go#L436><code>Push</code></a> æ“ä½œä¸­å¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸€æ¬¡ <code>Push</code> éƒ½ä¼šæ£€æŸ¥æ ˆå®¹é‡æ˜¯å¦è¶³å¤Ÿï¼Œå¦‚æœä¸å¤Ÿå°±ä¼šè§¦å‘ <a href=https://github.com/yuin/gopher-lua/blob/f4c35e4016d9d8580b007ebaeb68ecd8e0b09f1c/state.go#L388><code>resize</code></a>ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rg</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>) <span style=color:#a6e22e>resize</span>(<span style=color:#a6e22e>requiredSize</span> <span style=color:#66d9ef>int</span>) { <span style=color:#75715e>// +inline-start
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>newSize</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>requiredSize</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>rg</span>.<span style=color:#a6e22e>growBy</span> <span style=color:#75715e>// give some padding
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>newSize</span> &gt; <span style=color:#a6e22e>rg</span>.<span style=color:#a6e22e>maxSize</span> {
		<span style=color:#a6e22e>newSize</span> = <span style=color:#a6e22e>rg</span>.<span style=color:#a6e22e>maxSize</span>
	}
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>newSize</span> &lt; <span style=color:#a6e22e>requiredSize</span> {
		<span style=color:#a6e22e>rg</span>.<span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>registryOverflow</span>()
		<span style=color:#66d9ef>return</span>
	}
	<span style=color:#a6e22e>rg</span>.<span style=color:#a6e22e>forceResize</span>(<span style=color:#a6e22e>newSize</span>)
} <span style=color:#75715e>// +inline-end
</span></code></pre></div><p>è€Œåœ¨ <code>resize</code> å‡½æ•°ä¸­ï¼Œå¯ä»¥æ¸…æ¥šçš„çœ‹åˆ°ï¼Œå½“æ ˆå®¹é‡è¶…è¿‡ <code>maxSize</code> ï¼ˆé»˜è®¤ä¸º 5120ï¼‰çš„æ—¶å€™å°±ä¼šè§¦å‘ <code>registryOverflow</code> å³å †æ ˆæº¢å‡ºã€‚</p><p>è‡³æ­¤ï¼Œé—®é¢˜å…¶å®å·²ç»ååˆ†æ˜ç¡®äº†ã€‚åº”è¯¥æ˜¯æŸäº›æ“ä½œå‹æ ˆä¹‹åæ²¡æœ‰å–å‡ºï¼Œå¯¼è‡´å †æ ˆä¸€ç›´å †ç§¯ï¼Œæœ€åå¯¼è‡´æº¢å‡ºã€‚</p><h3 id=debug>Debug</h3><p>åœ¨è¿›è¡Œ <code>Debug</code> çš„æ—¶å€™å‘ç°ï¼Œåœ¨æ¯ä¸€æ¬¡è™šæ‹Ÿæœºå›æ”¶çš„æ—¶å€™ï¼Œæ ˆé¡¶æŒ‡é’ˆä¸€ç›´åœ¨é€’å¢ï¼š</p><p>å‰ä¸€æ¬¡å›æ”¶ï¼š
<img src=../../../tech/registry/01.png alt=å›¾1></p><p>åä¸€æ¬¡å›æ”¶ï¼š
<img src=../../../tech/registry/02.png alt=å›¾2></p><p>æ ˆå€¼éƒ½æ˜¯ <code>LNil</code>ï¼š
<img src=../../../tech/registry/03.png alt=å›¾3></p><p>æŒ‰ç…§æ—¶é—´æ¨ç®—ï¼Œ<strong>agent</strong> çš„è„šæœ¬ä¸€åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼Œé‚£ä¹ˆå †æ»¡ä¸€ä¸ªå®¹é‡ <code>5120</code> çš„è™šæ‹Ÿæœºå †æ ˆï¼Œéœ€è¦ <code>1</code> å¤©å¤šï¼Œ<code>4</code> ä¸ªè™šæ‹Ÿæœºå®ä¾‹æ­£å¥½å°±æ˜¯ <code>5</code> å¤©å·¦å³ï¼Œå®Œå…¨ç¬¦åˆæ•…éšœç°è±¡ã€‚</p><h3 id=æ’æŸ¥é—®é¢˜>æ’æŸ¥é—®é¢˜</h3><p>æ¥ä¸‹æ¥ï¼Œæœ€ä¸»è¦å°±æ˜¯æ‰¾åˆ°é—®é¢˜çš„åŸå› ï¼Œé¦–å…ˆéœ€è¦æ˜ç¡®åˆ°åº•æ˜¯ <code>go</code> å¯¼è‡´äº†å †æ ˆå †ç§¯è¿˜æ˜¯è°ƒç”¨ <code>lua</code> è„šæœ¬çš„æ—¶å€™å¯¼è‡´çš„ã€‚</p><p>äºæ˜¯ï¼Œæˆ‘å°±å†™äº†ä¸€ä¸ªååˆ†ç®€å•çš„æµ‹è¯• <code>lua</code> è„šæœ¬ï¼Œåª <code>print</code> ä¸€æ¡ä¿¡æ¯ã€‚</p><p>ç„¶åï¼Œæˆ‘å‘ç°è™šæ‹Ÿæœºå›æ”¶çš„æ—¶å€™å †æ ˆä¾æ—§åœ¨å †ç§¯ã€‚è¯´æ˜é—®é¢˜å¤§æ¦‚ç‡å‡ºåœ¨ <code>go</code> é‡Œã€‚</p><p>æ‰€ä»¥æˆ‘åˆä»”ç»†å›é¡¾äº† <strong>agent</strong> é‡Œè™šæ‹Ÿæœºçš„æ‰§è¡Œæµç¨‹ï¼Œå‘ç°è¿™å¤„ä»£ç ï¼š</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// è°ƒç”¨ run å‡½æ•°
</span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>vm</span>.<span style=color:#a6e22e>CallByParam</span>(<span style=color:#a6e22e>lua</span>.<span style=color:#a6e22e>P</span>{
	<span style=color:#a6e22e>Fn</span>:      <span style=color:#a6e22e>rfn</span>,
	<span style=color:#a6e22e>NRet</span>:    <span style=color:#ae81ff>1</span>,
	<span style=color:#a6e22e>Protect</span>: <span style=color:#66d9ef>true</span>,
}, <span style=color:#66d9ef>nil</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Logger</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#e6db74>&#34;call run func failed&#34;</span>, <span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>err</span>), <span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>Any</span>(<span style=color:#e6db74>&#34;lua&#34;</span>, <span style=color:#a6e22e>lname</span>))
}
<span style=color:#75715e>// å½’è¿˜è™šæ‹Ÿæœº
</span><span style=color:#75715e></span><span style=color:#a6e22e>luavm</span>.<span style=color:#a6e22e>Put</span>(<span style=color:#a6e22e>vm</span>)
</code></pre></div><p>é—®é¢˜è²Œä¼¼å°±åœ¨è¿™é‡Œï¼Œæ˜¯ä¸æ˜¯è°ƒç”¨ <code>lua</code> è„šæœ¬ä¸­çš„ <code>run</code> å‡½æ•°åå°†ç»“æœå‹æ ˆäº†ï¼Œç„¶åæ²¡æœ‰è¿›è¡Œ <code>POP</code> ï¼Ÿ</p><p><strong>agent</strong> ä¸­è°ƒç”¨çš„ <code>lua</code> è„šæœ¬æ˜¯ä¸è¿”å›å€¼çš„ï¼Œè¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆæ ˆå€¼éƒ½æ˜¯ <code>LNil</code>ã€‚</p><p>ä¸ºäº†éªŒè¯è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘å°†æµ‹è¯•è„šæœ¬ä¸­çš„ <code>run</code> æ–¹æ³•æ”¹æˆäº†å¦‚ä¸‹ï¼š</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>run</span>()
    inspect()
    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>123</span>
<span style=color:#66d9ef>end</span>
</code></pre></div><p>ç„¶åï¼Œæˆ‘ä»¬å†æ¥ <code>Debug</code> çœ‹ä¸‹å †æ ˆé‡Œçš„æƒ…å†µ</p><p><img src=../../../tech/registry/04.png alt=å›¾4></p><p>æœç„¶ï¼Œç±»å‹ä» <code>LNil</code> å˜æˆäº† <code>LNumber</code>ï¼Œé—®é¢˜æœç„¶åœ¨è¿™é‡Œï¼</p><h3 id=ä¿®å¤>ä¿®å¤</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// è°ƒç”¨ run å‡½æ•°
</span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>vm</span>.<span style=color:#a6e22e>CallByParam</span>(<span style=color:#a6e22e>lua</span>.<span style=color:#a6e22e>P</span>{
	<span style=color:#a6e22e>Fn</span>:      <span style=color:#a6e22e>rfn</span>,
	<span style=color:#a6e22e>NRet</span>:    <span style=color:#ae81ff>1</span>,
	<span style=color:#a6e22e>Protect</span>: <span style=color:#66d9ef>true</span>,
}, <span style=color:#66d9ef>nil</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Logger</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#e6db74>&#34;call run func failed&#34;</span>, <span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>err</span>), <span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>Any</span>(<span style=color:#e6db74>&#34;lua&#34;</span>, <span style=color:#a6e22e>lname</span>))
}

<span style=color:#75715e>// ç›¸ä¿¡æˆ‘ï¼Œè°ƒç”¨ call åä¸€å®šè¦ pop ï¼ï¼ä¸ç„¶ä¸€å®šä¸ä¼šè®©ä½ å¤±æœ›
</span><span style=color:#75715e></span><span style=color:#a6e22e>vm</span>.<span style=color:#a6e22e>Pop</span>(<span style=color:#ae81ff>1</span>)
<span style=color:#75715e>// å½’è¿˜è™šæ‹Ÿæœº
</span><span style=color:#75715e></span><span style=color:#a6e22e>luavm</span>.<span style=color:#a6e22e>Put</span>(<span style=color:#a6e22e>vm</span>)
</code></pre></div><p>ä¿®å¤è¿™ä¸ªé—®é¢˜å¾ˆç®€å•ï¼Œåªéœ€åœ¨å½’è¿˜è™šæ‹Ÿæœºå‰ï¼Œæ‰§è¡Œä¸€æ¬¡ POPã€‚éšåå‘ç°æ¯æ¬¡å›æ”¶è™šæ‹Ÿæœºçš„æ—¶å€™ï¼Œå°±æ²¡æœ‰æ ˆå †ç§¯çš„æƒ…å†µäº†ã€‚</p><p>å¦å¤–ï¼Œä¹Ÿå¯ä»¥åœ¨è™šæ‹Ÿæœºå›æ”¶çš„æ—¶å€™åšä¸€äº›èµ„æºæ¸…ç†ã€‚</p><h2 id=æ€»ç»“>æ€»ç»“</h2><p>å¤šé˜…è¯»åº•å±‚å®ç°ï¼Œå¤šå»æªæªé—®é¢˜çš„æœ¬è´¨ï¼Œä¸€èˆ¬æ²¡æœ‰ä»€ä¹ˆè§£å†³ä¸äº†çš„é—®é¢˜ğŸ˜</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://callous.cn/tags/tech>tech</a></li></ul></footer><figure class=article-discussion><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"edboffical"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></figure></article></main><footer class=footer><span>&copy; 2021 <a href=https://callous.cn>callous' blog</a></span></footer><a href=#top aria-label="go to top" title="Go to Top" accesskey=g><button class=top-link id=top-link type=button><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6"><path d="M12 6H0l6-6z"/></svg></button></a>
<script src=https://callous.cn/assets/js/highlight.min.e7afc2928c0925d65c4732dfebe147014d91299a98e819e4b42f25c4fa68e91c.js integrity="sha256-56/CkowJJdZcRzLf6+FHAU2RKZqY6BnktC8lxPpo6Rw="></script><script>hljs.initHighlightingOnLoad();</script><script>window.onload=function(){if(localStorage.getItem("menu-scroll-position")){document.getElementById('menu').scrollLeft=localStorage.getItem("menu-scroll-position");}}
document.querySelectorAll('a[href^="#"]').forEach(anchor=>{anchor.addEventListener("click",function(e){e.preventDefault();var id=this.getAttribute("href").substr(1);document.querySelector(`[id='${id}']`).scrollIntoView({behavior:"smooth"});});});var mybutton=document.getElementById("top-link");window.onscroll=function(){if(document.body.scrollTop>800||document.documentElement.scrollTop>800){mybutton.style.visibility="visible";mybutton.style.opacity="1";}else{mybutton.style.visibility="hidden";mybutton.style.opacity="0";}};function menu_on_scroll(){localStorage.setItem("menu-scroll-position",document.getElementById('menu').scrollLeft);}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{if(document.body.className.includes("dark")){document.body.classList.remove('dark');localStorage.setItem("pref-theme",'light');}else{document.body.classList.add('dark');localStorage.setItem("pref-theme",'dark');}})</script></body></html>